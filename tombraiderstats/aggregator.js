// 2017-11-25
var ljacqu={};ljacqu.config={classesToAggregate:["enemy","item","hazard","secret","gold","silver","friendly","crystal"],maximumEntryLength:100,plurals:{"cat mummies":"cat mummy",enemies:"enemy","guard dog":"dog",gunmen:"gunman","hk ammo":"hk clips",huskies:"dog",husky:"dog","large medipak":"large medipack",men:"man",mercenaries:"mercenary","mp5 ammo":"mp5 clips",mummies:"mummy","shotgun ammo":"shotgun shells","small medipak":"small medipack","smg ammo":"smg clips",switches:"switch",tribesmen:"tribesman","wild boar":"boar","wolf's":"wolf",wolves:"wolf"},selectEntities:function(t){return"span."+t}},ljacqu.status={},ljacqu.total={},ljacqu.loadJquery=function(t){var e=0,a=function(){e++,"undefined"==typeof jQuery?e<100?setTimeout(a,100):console.error("Could not load jQuery!"):t()};if("undefined"==typeof jQuery){delete $;var n=document.createElement("script");n.src="https://ajax.googleapis.com/ajax/libs/jquery/1.6.3/jquery.min.js",document.getElementsByTagName("head")[0].appendChild(n),a()}else t()},ljacqu.game=function(){var t=function(t){$('h2:contains("Walkthrough")').next("div").prepend($('<table id="agg_options">'));var e=$("#agg_options");e.append('<tr><td colspan="3">Please click on the OS to get the walkthrough for. <span class="em4" id="agg_click_msg">Click to select</span></td></tr>'),$("#agg_click_msg").hide(),e.append($("<tr>"));for(var a=0;a<t.length;a++){e.find("tr:last").append('<td><span class="em5" style="font-weight: bold" title="Click to select">'+t[a]+"</span></td>");var n=e.find("tr:last td:eq("+a+")");n.on("click",function(a){return function(){ljacqu.status.optionOs=t[a],e.remove(),ljacqu.run.overviewPageRunner()}}(a)),n.hover(function(){$(this).find("span").attr("class","em3"),$("#agg_click_msg").show()},function(){$(this).find("span").attr("class","em5"),$("#agg_click_msg").hide()})}},e=function(){var t=ljacqu.status.optionOs,e=$('[class^="walk-table"] a[href^="walks/"]').filter(':contains("'+t+'")');return $.each(e,function(t){var a=$(this).closest("p").text().match(/^(.*?)\(/);e[t].text=a[1].trim()}),e};return{detectModeAndGame:function(){var t=/\/stella\/([a-z0-9\-_]+)\.html/i,e=/\/stella\/walks\/([a-z0-9\-_]+)\/.*?\.html/i,a=window.location.href,n=a.match(t);if(null!==n)return["overview",n[1]];if(null!==(n=a.match(e)))return["single",n[1]];throw ljacqu.display.displayError("Please make sure you are on a walkthrough or overview page!"),new Error("Did not recognize URL")},getWalkthroughLinks:function(){return"tomb1"===ljacqu.status.game?$('a[href^="walks/TR1walk/"]'):"tomb2"===ljacqu.status.game?$('a[href^="walks/TR2walk/"]'):"tomb3"===ljacqu.status.game?$('a[href^="walks/TR3walk/"]').filter(':not(:contains("BUG WARNINGS"))'):"lostartifact"===ljacqu.status.game?$('a[href^="walks/TRLAwalk/"]').filter(':not(:contains("Installing"))'):"tomb4"===ljacqu.status.game?$('a[href^="walks/TR4walk/"]').filter(':not(:contains("Cairo  Overview"))'):"tomb5"===ljacqu.status.game?$('a[href^="walks/TR5walk/"]').filter(':contains("Level")'):"tomb7"===ljacqu.status.game?$('a:contains("Croft Manor"), a[href^="walks/TR7walk/0"]'):"anniversary"===ljacqu.status.game?$('a[href^="walks/TRAwalk/"]').filter(':contains("Level"), :contains("Croft Manor")'):"tomb8"===ljacqu.status.game?void 0===ljacqu.status.optionOs?(t(["PC/Mac/PS3/Xbox 360","Wii","PS2"]),!1):e():"tomb9"===ljacqu.status.game?$('[class^="walk-table"] a[href^="walks/"]').filter(':contains("Area"), :contains("Shantytown")'):"tomb10"===ljacqu.status.game?$('a[href^="walks/TR10walk/"]').filter('a[href^="walks/TR10walk/0"], a[href^="walks/TR10walk/1"]').filter(':not(:contains("100%"))'):$('[class^="walk-table"] a[href^="walks/"]')}}}(),ljacqu.text=function(){var t=function(t){return t.match(/^secret #\d+$/i)?"secret":t.replace(/^\W+/,"").replace(/\W+$/,"").trim().toLowerCase()},e=function(e){if(""===(e=t(e)))return{name:"",number:0};var a=e.match(/^(\d+) (.*)$/);if(a)return{number:parseInt(a[1]),name:a[2]};var n=["one","two","three","four","five","six"],r=new RegExp("^("+n.join("|")+")\\s(.*?)$"),i=e.match(r);return i?(n.unshift(0),{name:i[2],number:n.indexOf(i[1])}):{name:e,number:1}},a=function(t,e){if(t=t.toLowerCase(),void 0!==ljacqu.config.plurals[t])return ljacqu.config.plurals[t];if("s"===t.substr(t.length-1)){var a=t.substr(0,t.length-1);if(void 0!==e[a])return a}return t},n=function(){var t=["first","second","third","fourth","fifth","sixth","seventh","eighth","ninth","tenth"],e=["the","a"],a=["more","additional","another","other","sets of","boxes of","bunches of","bundles of","bundle of"],n=function(t){return"("+t.join("\\s|")+"\\s)"};return new RegExp("^("+n(a)+"|"+n(e)+"?"+n(t)+"?)?(.*?)$","i")},r=function(t,e){var r=t.match(n()),i=r?r[r.length-1]:t;return(i=a(i,e))!==t&&(console.log(t+" renamed to "+i),void 0!==e[i]?e[i]+=e[t]:e[i]=e[t],delete e[t]),e},i=function(t){var e=t;for(var a in t)t.hasOwnProperty(a)&&(e=r(a,e));return e},o=function(t,e){for(var a in t)t.hasOwnProperty(a)&&(void 0!==ljacqu.total[e][a]?ljacqu.total[e][a]+=t[a]:ljacqu.total[e][a]=t[a])},l=function(t){var e=[];for(var a in t)t.hasOwnProperty(a)&&e.push([a,t[a]]);return e.sort(function(t,e){var a=e[1]-t[1];return 0!==a?a:t[0]>e[0]?1:t[0]<e[0]?-1:0}),e};return{createdSortedPairArray:l,fetchEntities:function(t,a){a=a||document;var n={};$.each($(ljacqu.config.selectEntities(t),a),function(){var t=e($(this).text());""!==t.name&&(void 0===n[t.name]?n[t.name]=t.number:n[t.name]+=t.number)});var r=i(i(n));return"overview"===ljacqu.status.mode&&o(r,t),l(r)}}}(),ljacqu.container=function(){var t=function(){var t="overview"===ljacqu.status.mode?$("#wrap"):$("#LayoutDiv1");if(0===t.length){if("TR9walk"===ljacqu.status.game)return $(".gridContainer").prepend($('<div id="LayoutDiv1">')),$("#LayoutDiv1");throw new Error("Could not get base element!")}return t},e=function(t){var e=t.split("/");return"ctr_"+e[e.length-1].split(".")[0]},a=function(a){var n=e(a.url),r=$("#"+n);if(0!==r.length)return r;t().before('<div id="'+n+'"><h1>'+a.text+"</h1></div>");var i=$("#"+n);return i.find("h1").click(function(){i.find("div:visible").length>0?i.find("div").hide():i.find("div").show()}),i},n=function(t){var n=e(t.url),r=$("#"+n);return 0===r.length&&(r=a(t)),r},r=function(t){return"sec_"+t},i=function(t,e,a){var r=n(e),i="overview"===ljacqu.status.mode&&"_total"!==e.url?' style="display: none"':"";r.append('<div class="'+t+'"'+i+"><h2>"+a+"</h2><table></table></div>");var o=r.find("."+t);return o.find("h2").click(function(){o.find("table").toggle()}),o};return{createContainer:a,getContainer:n,getSection:function(t,e){var a=n(e=e||{url:"results",text:"Statistics"}),o=r(t),l=a.find("."+o);if(0===l.length){var s=t.charAt(0).toUpperCase()+t.substr(1);l=i(o,e,s)}return l},removeAllSections:function(t){$('div[id^="ctr"] div.sec_'+t).remove()},removeAll:function(){t().prevAll("div").remove()}}}(),ljacqu.display=function(){var t=function(t,e){return t.length>e?t.substr(0,e).trim()+"...":t},e=function(e,a){for(var n=0,r=0;r<a.length;++r)n+=a[r][1],e.append($("<tr>").append("<td>"+t(a[r][0],ljacqu.config.maximumEntryLength)+'</td><td style="text-align: right">'+a[r][1]+"</td>"));a.length>=2&&e.append('<tr class="agg_total"><td>Total</td><td style="text-align: right">'+n+"</td></tr>")},a=function(t,e){if("single"===ljacqu.status.mode){var a=2===t.find("tr").length?"tr":"tr:not(:last-child)";t.find(a).find("td:first").attr("class",e)}else{void 0!==t.attr("style")&&-1!==t.attr("style").indexOf("width: auto")||t.attr("style","width: auto"),t.find("tr:even").attr("style","background:#343434;color:#BCBCBC"),t.find("tr.agg_total").find("td").attr("style","border-top: 1px solid #ccc")}},n=function(t,n,r){var i=ljacqu.container.getSection(n,r).find("table");i.html("<tr><th>Type</th><th>Total</th></tr>"),t.length>0?(e(i,t),a(i,n),ljacqu.status.classes[n]=!0):i.html("<tr><td>No entities found.</td></tr>")},r=function(){for(var t=0;t<ljacqu.config.classesToAggregate.length;t++){var e=ljacqu.config.classesToAggregate[t];void 0===ljacqu.status.classes[e]&&ljacqu.container.removeAllSections(e)}},i=function(){var t={url:"_total",text:"Total"};ljacqu.container.createContainer(t);for(var e in ljacqu.total)ljacqu.total.hasOwnProperty(e)&&n(ljacqu.text.createdSortedPairArray(ljacqu.total[e]),e,t)};return{displayEntities:n,displayError:function(t){var e=$("#agg_err");0===e.length&&($("body").prepend('<div id="agg_err" style="color:#300; display:block; border:1px solid #900; background-color:#fee; padding:10px; margin:20px; z-index:2015; opacity:1"></div>'),e=$("#agg_err")),e.hide(),$("html, body").animate({scrollTop:0},"slow"),e.html(t),e.fadeIn()},postProcess:function(){"single"===ljacqu.status.mode?r():ljacqu.status.handledLinks===ljacqu.status.foundLinks&&(i(),r())}}}(),ljacqu.run=function(){var t=function(t,e){for(var a=0;a<ljacqu.config.classesToAggregate.length;++a){var n=ljacqu.config.classesToAggregate[a],r=ljacqu.text.fetchEntities(n,t);ljacqu.display.displayEntities(r,n,e)}ljacqu.status.handledLinks++,ljacqu.display.postProcess()},e=function(t){return{url:t.attr("href").split("#")[0],text:t.text().replace(/\s{2,}/g," ")}},a=function(t){var e=ljacqu.container.getContainer(t).find("h1");-1===e.text().indexOf(t.text)&&e.append('<span style="font-size: 0.8em"> + '+t.text+"</span>")};return{initStatus:function(){var t=ljacqu.game.detectModeAndGame();ljacqu.status={mode:t[0],game:t[1],classes:{},foundLinks:0,handledLinks:0},ljacqu.total={};for(var e=ljacqu.config.classesToAggregate,a=0;a<e.length;++a)ljacqu.total[e[a]]={}},processPage:t,overviewPageRunner:function(){var n=ljacqu.game.getWalkthroughLinks();if("boolean"!=typeof n){console.log("Found "+n.size()+" links"),ljacqu.status.foundLinks=n.length;var r={};$.each(n,function(){var n=e($(this));if(void 0!==r[n.url])return a(n),ljacqu.status.handledLinks++,void ljacqu.display.postProcess();ljacqu.container.createContainer(n),r[n.url]=!0,$.get(n.url,{},function(e){t(e.replace(/<img/g,"<cheese"),n)},"html")})}else console.log("Aborted link retrieval")},checkWebsite:function(){var t=/^https?:\/\/(www\.)?tombraiders\.net(\/.*)?$/i.test(window.location.href);return t||ljacqu.display.displayError('You are not on <b><a href="http://tombraiders.net">tombraiders.net</a></b>'),t}}}(),ljacqu.loadJquery(function(){ljacqu.run.checkWebsite()&&(ljacqu.run.initStatus(),"overview"===ljacqu.status.mode?ljacqu.run.overviewPageRunner():ljacqu.run.processPage())});